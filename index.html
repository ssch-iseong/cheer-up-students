<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수험생 여러분, 힘내세요!</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM for the UI -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and global variables are provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.firebase = {
            initializeApp,
            getAuth,
            signInWithCustomToken,
            onAuthStateChanged,
            signInAnonymously,
            getFirestore,
            collection,
            query,
            addDoc,
            onSnapshot,
            serverTimestamp,
            firebaseConfig,
            appId,
            initialAuthToken
        };
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously, getFirestore, collection, query, addDoc, onSnapshot, serverTimestamp, firebaseConfig, appId, initialAuthToken } = window.firebase;
        
        // Custom modal component for alerts
        const Modal = ({ message, onClose }) => (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                <div className="relative p-8 bg-white w-96 rounded-lg shadow-lg text-center">
                    <h3 className="text-xl font-bold mb-4">알림</h3>
                    <p className="text-gray-700 mb-6">{message}</p>
                    <button
                        onClick={onClose}
                        className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                    >
                        닫기
                    </button>
                </div>
            </div>
        );

        // Main App component
        const App = () => {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [userId, setUserId] = useState(null);
            const [db, setDb] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [modalMessage, setModalMessage] = useState('');

            const showCustomModal = (message) => {
                setModalMessage(message);
                setShowModal(true);
            };
            
            // Firebase initialization and authentication
            useEffect(() => {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Please check the environment variables.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const authInstance = getAuth(app);
                setDb(firestore);
                
                const unsubscribeAuth = onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setIsAuthReady(true);
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(authInstance, initialAuthToken);
                            } else {
                                await signInAnonymously(authInstance);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            setIsAuthReady(true);
                        }
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            // Firestore listener to fetch messages
            useEffect(() => {
                if (!db || !isAuthReady) {
                    return;
                }

                setIsLoading(true);
                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/encouragement-messages`);
                const q = query(messagesCollectionRef);

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const fetchedMessages = [];
                    querySnapshot.forEach((doc) => {
                        const messageData = doc.data();
                        fetchedMessages.push({ id: doc.id, ...messageData });
                    });
                    // Sort the messages by timestamp in descending order on the client side
                    fetchedMessages.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    setMessages(fetchedMessages);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching messages:", error);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, isAuthReady, appId]);

            // Handle message submission
            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !db || !userId) {
                    showCustomModal("메시지를 입력해주세요.");
                    return;
                }

                const messageData = {
                    text: newMessage,
                    timestamp: serverTimestamp(),
                    senderId: userId,
                };

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/encouragement-messages`), messageData);
                    setNewMessage('');
                    showCustomModal("메시지가 성공적으로 전송되었습니다!");
                } catch (error) {
                    console.error("Error adding message:", error);
                    showCustomModal("메시지 전송에 실패했습니다. 다시 시도해주세요.");
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
                    {showModal && <Modal message={modalMessage} onClose={() => setShowModal(false)} />}
                    <div className="w-full max-w-2xl bg-white shadow-lg rounded-xl p-6 md:p-8 space-y-8 mt-12">
                        <header className="text-center">
                            <h1 className="text-3xl md:text-4xl font-extrabold text-gray-800 tracking-tight leading-tight">
                                수험생 여러분, 힘내세요!
                            </h1>
                            <p className="mt-2 text-md md:text-lg text-gray-600">
                                여러분의 따뜻한 응원 메시지가 큰 힘이 됩니다.
                            </p>
                        </header>
                        <div className="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-lg">
                            <p><span className="font-bold">안내:</span> 수험생들을 위한 응원 메시지를 남겨주세요.</p>
                        </div>
                        <div className="text-center text-sm text-gray-400">
                            <p>사용자 ID: {userId ? userId : '인증 중...'}</p>
                        </div>
                        <form onSubmit={handleSendMessage} className="space-y-4">
                            <textarea
                                className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-200 h-32 resize-none"
                                placeholder="여기에 응원 메시지를 작성해주세요..."
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                maxLength="300"
                            ></textarea>
                            <button
                                type="submit"
                                className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105 shadow-md hover:shadow-lg"
                            >
                                메시지 보내기
                            </button>
                        </form>
                        <hr className="border-t-2 border-gray-200 my-8" />
                        <section className="space-y-4">
                            <h2 className="text-2xl font-bold text-gray-800 text-center">모두가 남긴 응원 메시지</h2>
                            {isLoading ? (
                                <div className="flex justify-center items-center h-40">
                                    <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                                </div>
                            ) : messages.length === 0 ? (
                                <p className="text-center text-gray-500 py-8">아직 메시지가 없네요. 첫 번째 응원 메시지를 남겨주세요!</p>
                            ) : (
                                <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                                    {messages.map((msg) => (
                                        <div key={msg.id} className="bg-gray-50 p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-between h-full transform hover:scale-105 transition duration-300 ease-in-out">
                                            <p className="text-gray-700 text-base leading-relaxed break-words whitespace-pre-wrap">
                                                {msg.text}
                                            </p>
                                            {msg.timestamp && (
                                                <p className="mt-4 text-xs text-gray-400 text-right">
                                                    {new Date(msg.timestamp.toMillis()).toLocaleString()}
                                                </p>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>
                    </div>
                    <footer className="mt-8 text-center text-gray-500 text-sm">
                        <p></p>
                    </footer>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
